import textract
from langchain.chains import ConversationalRetrievalChain
from langchain.llms import OpenAI
from langchain.chains.question_answering import load_qa_chain
from langchain.vectorstores import FAISS
from langchain.embeddings import OpenAIEmbeddings
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.document_loaders import PyPDFLoader
from transformers import GPT2TokenizerFast
import matplotlib.pyplot as plt
import pandas as pd
import openai
import os
from pymilvus import MilvusClient, connections, FieldSchema, CollectionSchema, DataType, Collection, utility
from langchain.document_loaders import UnstructuredFileLoader

import random
import json

from dotenv import load_dotenv

# Load environment variables from the .env file
load_dotenv()


openai.api_key = os.getenv("OPENAI_API_KEY")


doc = textract.process("./dispactManualTruncated.pdf")

with open('dispactManul.txt', 'w') as f:
    f.write(doc.decode('utf-8'))

with open('dispactManul.txt', 'r') as f:
    text = f.read()

text_splitter = RecursiveCharacterTextSplitter(
    # Set a really small chunk size, just to show.
    chunk_size=512,
    chunk_overlap=200,
)

# chunks = text_splitter.create_documents([text])
# data = []
# chunkCount = 0
# for chunk in chunks:
#     # print("TYPEOFHERE", type(str(chunk)))
#     print(chunkCount)
#     chunkCount += 1
#     # print(chunk, "\n\n\n\n\n")
#     response = openai.Embedding.create(
#         input="Your text string goes here",
#         model="text-embedding-ada-002"
#     )
#     embedding = response['data'][0]['embedding']
#     # embedding = [-0.007021795958280563, -0.0052579473704099655, 0.011873218230903149, -0.024888738989830017, -0.024579644203186035, 0.03972522169351578, -0.010065694339573383, -0.00940719060599804, -0.013257419690489769, -0.01002537738531828, -0.011732110753655434, 0.007747493218630552, -0.01416454091668129, 0.007760932203382254, 0.010280715301632881, -0.005053005181252956, 0.022940106689929962, -0.0015496666310355067, 0.015024627558887005, -0.010388226248323917, 0.004844703245908022, 0.01245780847966671, 0.004844703245908022, 0.01089218258857727, -0.006692544091492891, -0.0003231621813029051, 0.005570400506258011, -0.012578757479786873, 0.016381951048970222, 0.0044885738752782345, 0.006605191621929407, -0.00718306191265583, -0.015091821551322937, -0.006581673864275217, -0.018505288287997246, 0.0041694012470543385, 0.003178286598995328, -0.018975647166371346, 0.030291153118014336, -0.007465277798473835, 0.008117061108350754, 0.009521421045064926, -0.0011330625275149941, -0.00042584334732964635, -0.008829319849610329, -0.028570981696248055, 0.00296998443081975, 0.0092728016898036, 0.01644914411008358, 0.006501040421426296, 0.019472884014248848, 0.014809605665504932, -0.02576226368546486, -0.009931305423378944, -0.0032975561916828156, 0.014997749589383602, -0.03690306469798088, 0.014057030901312828, 0.01335821021348238, 0.0043945019133389, -0.004888379480689764, 0.003195085097104311, -0.01108032651245594, 0.0024240314960479736, -0.014204857870936394, -0.0185456033796072, -0.024673717096447945, -0.003504178486764431, 0.018048366531729698, 0.008500068448483944, 0.034215297549963, 0.015145576559007168, 0.014083907939493656, -0.006591752637177706, 0.021985948085784912, 0.02205314300954342, 0.005449451040476561, 0.02083020843565464, 0.008298485539853573, -0.011900096200406551, 0.007639982737600803, -0.025036565959453583, 0.010663722641766071, 0.016771676018834114, 0.00946094561368227, -0.0006089475937187672, -0.002991822548210621, 0.028974147513508797, -0.032952044159173965, -0.03042554296553135, 0.007734054699540138, 0.020104510709643364, 0.009917866438627243, 0.018034927546977997, -0.00563087547197938, 0.008271608501672745, -0.010200082324445248, 0.020413603633642197, 0.02233535796403885, -0.03467221558094025, 0.00534529983997345, 0.013190224766731262, -0.01738986372947693, -0.008150658570230007, -0.029807355254888535, 0.01777959056198597, 0.021542467176914215, -0.01683887094259262, 0.016301317140460014, 0.0037628761492669582, -0.029242923483252525, 0.012202469632029533, -0.01816931739449501, -0.01721515879034996, 0.0030825347639620304, 0.016865748912096024, 0.010744355618953705, -0.01397639699280262, -0.02148871123790741, -0.03015676513314247, 0.009971622377634048, 0.012585476972162724, 0.03023739904165268, -0.0175780076533556, 0.026313256472349167, 0.01958039589226246, -0.0058626956306397915, -0.03131250664591789, 0.006702623330056667, -0.0018394417129456997, 0.03738686442375183, 0.024458695203065872, 0.010757794603705406, 0.014863360673189163, -0.013109591789543629, 0.022980421781539917, -0.035989224910736084, 0.0025852974504232407, -0.027549630030989647, -0.012780340388417244, 0.012955045327544212, 0.026971759274601936, 0.0028271968476474285, -0.003074135398492217, 0.01274002343416214, 0.011053448542952538, -0.002185491845011711, -0.010522614233195782, 0.0213811993598938, -0.012988642789423466, -0.0027902398724108934, 0.0040215738117694855, 0.004928695969283581, -0.0149708716198802, -0.010603247210383415, 0.01721515879034996, 0.0054158540442585945, 0.008043147623538971, 0.001920074806548655, -0.029995499178767204, 0.011019852012395859, 0.00922576617449522, 0.01691950485110283, -0.014513950794935226, 0.03397339582443237, 0.05114823952317238, -0.0036788834258913994, 0.005436012055724859, -0.0058526163920760155, -0.008318644016981125, -0.029646089300513268, 0.028570981696248055, -0.06418392062187195, 0.012726585380733013, -0.041418515145778656, 0.0036990416701883078, 0.0261385515332222, 0.01331789419054985, -0.020749574527144432, -0.019042842090129852, -0.03983273357152939, 0.0023887543939054012, 0.004908537492156029, 0.02511719800531864, -0.02721365913748741, -0.01393608096987009, 4.60910341644194e-05, 0.004088768269866705, 0.0008008711156435311, 0.003052297281101346, 0.016583533957600594, 0.022026265040040016, 0.009286240674555302, -0.008022990077733994, -0.6893589496612549, -0.003813271876424551, 0.020588308572769165, -0.026286378502845764, 0.02558755874633789, 0.038381338119506836, 0.0008269088575616479, 0.018679993227124214, -0.025600997731089592, 0.020601747557520866, -0.01921754702925682, -0.002471067477017641, -0.010932499542832375, -0.012410772033035755, 0.0029095096979290247, -0.01269970741122961, 0.010294154286384583, -0.006554795894771814, -0.01478272769600153, 0.00836568046361208, 0.005056364927440882, 0.032387614250183105, 0.0016403788467869163, 0.01431236881762743, 0.01911003515124321, -0.00012945386697538197, 0.009877550415694714, -0.01881438121199608, -0.0017638482386246324, 0.03185005858540535, -0.029350435361266136, -0.003228682093322277, -0.002477786736562848, 0.010549492202699184, 0.06095859408378601, -0.02064206451177597, -0.009440788067877293, -0.005002609454095364, -0.005556961987167597, 0.0017739273607730865, -0.018048366531729698, -0.026084795594215393, 0.02100491337478161, -0.004465055651962757, 0.0058324579149484634, -0.004065250046551228, 0.0049690124578773975, -0.021179618313908577, 0.0052545880898833275, 0.005674551706761122, 0.0018814380746334791, -0.0018881575670093298, 0.010865305550396442, -0.0013144868426024914, 0.014809605665504932, 0.009817074984312057, 0.043219320476055145, -0.016529778018593788, 0.001268290914595127, 0.015494986437261105, -0.0037931136321276426, 0.022093458101153374, -0.02910853549838066, -0.013660584576427937, 0.0028557542245835066, 0.00960877351462841, -0.011913535185158253, 0.0066522276028990746, 0.009669248014688492, -0.005792141426354647, 0.015844397246837616, 0.013855447992682457, -0.020292654633522034, -0.006064278073608875, 0.0019939884077757597, 0.026770176365971565, 0.018572481349110603, -0.009373593144118786, -0.020615186542272568, 0.018236510455608368, 0.006682464852929115, -0.003625128185376525, -0.023128250613808632, -0.01655665598809719, 0.025251587852835655, -0.006067637819796801, -0.022295041009783745, 0.009447506628930569, 0.006759738549590111, 0.004700235556811094, 0.013143189251422882, 0.01087874360382557, -0.008110342547297478, -0.001412758487276733, 0.00410892628133297, 0.005812299903482199, -2.513221261324361e-05, 0.014204857870936394, -0.0077071767300367355, -0.003719199914485216, -0.014796166680753231, 0.01597878523170948, -0.028382837772369385, 0.0054259332828223705, 0.007660140749067068, -0.0015547062503173947, -0.0032303619664162397, 0.019244424998760223, 0.03308643400669098, -0.0237867534160614, -0.006077717058360577, -0.008708370849490166, -0.0028456752188503742, -0.01335821021348238, -0.006648867856711149, -0.023921141400933266, 0.010206801816821098, 0.005513285752385855, 0.02366580441594124, -0.0002460988180246204, 0.020964596420526505, -0.0027784809935837984, -0.0030270994175225496, 0.0011868178844451904, 0.026770176365971565, 0.00817753653973341, 0.007633263245224953, -0.0213811993598938, -0.022308479994535446, -0.003998056054115295, 0.007498874794691801, -0.0008878036169335246, 0.054239172488451004, -0.016973258927464485, 0.02521127089858055, -0.002434110501781106, 0.018397776409983635, -0.0007630743202753365, 0.016099734231829643, -0.005301623605191708, -0.02005075477063656, 0.015266526490449905, -0.0175914466381073, 0.0066085513681173325, 0.0104621397331357, -0.018384337425231934, -0.018706871196627617, -0.0072368173860013485, 0.00946766510605812, -0.010321032255887985, 0.0020443841349333525, -0.012525002472102642, -0.024512451142072678, 0.0266357883810997, 0.012256225571036339, -0.01787366159260273, 0.00482454476878047, -0.01579064130783081, -0.00755934976041317, -0.021529028192162514, -0.001815923722460866, 0.011302067898213863, -0.010952658019959927, 0.01615349017083645, -0.010206801816821098, -0.004549048375338316, -0.03776315227150917, 0.013385088182985783, -0.016516339033842087, -0.026393888518214226, -0.0032538799569010735, -0.02084364742040634, -0.00584925664588809, -0.00024756870698183775, -0.014003274962306023, -0.004364264663308859, -0.019996998831629753, -0.0019603914115577936, 0.02302073873579502, -0.016314756125211716, 0.008540385402739048, 0.013842009007930756, -0.002808718243613839, 0.015293404459953308, 0.016502900049090385, 0.014191418886184692, -0.0017789669800549746, 0.015763763338327408, 0.007700457237660885, -0.01787366159260273,
#     #              0.003735998645424843, -0.013465721160173416, -0.013405246660113335, 0.0005358738708309829, -0.011570844799280167, 0.00039224623469635844, -0.007955795153975487, 0.03034490905702114, 0.017322668805718422, 0.008829319849610329, 0.03367774188518524, 0.0063095372170209885, 0.042843032628297806, -0.025708507746458054, -0.00458936532959342, -0.021636538207530975, 0.0024475494865328074, -0.022375674918293953, 0.018021488562226295, 0.01274674292653799, 0.003910703584551811, -0.021273689344525337, -0.012148714624345303, 0.010233679786324501, 0.015293404459953308, 0.025802580639719963, -0.0073712058365345, 0.00779452919960022, -0.0019402330508455634, 0.008238011039793491, 0.00498917093500495, -0.006793335545808077, 0.00411564577370882, -0.012430930510163307, -0.013418685644865036, 0.005684630945324898, 0.026662666350603104, 0.03574732318520546, 0.005684630945324898, -0.023692680522799492, -0.0030556570272892714, -0.0039140633307397366, 0.0009012424270622432, 0.010959376581013203, 0.013788254000246525, 0.01768551766872406, 0.029162291437387466, 0.0008529465994797647, 0.028974147513508797, -0.003564653219655156, -0.010616686195135117, 0.023087933659553528, 0.018800942227244377, -0.0073980833403766155, 0.02435118518769741, 0.004572566598653793, 0.02015826478600502, 0.0014522350393235683, -0.01967446692287922, 0.010011938400566578, -0.01131550595164299, 0.012605635449290276, -0.03166191652417183, -0.006386810448020697, 0.021367762237787247, -0.013324613682925701, 1.59848750627134e-05, 0.013371649198234081, 0.026205744594335556, 0.018800942227244377, 0.015844397246837616, -0.01890845224261284, -0.004444897640496492, -0.0005921490374021232, 0.018975647166371346, -0.009944744408130646, -0.014070468954741955, -0.004619602579623461, -0.01682543195784092, 0.014110785908997059, -0.007357766851782799, -0.0071091484278440475, 0.03526352718472481, -0.00822457205504179, 0.024189919233322144, -0.0002538681437727064, 0.009541578590869904, -0.0009398791007697582, -0.01691950485110283, 0.004370983690023422, 0.0013926001265645027, -0.044348184019327164, 0.007317450363188982, 0.0072368173860013485, -0.002024225890636444, -0.01939225196838379, -0.033623985946178436, 0.037413742393255234, 0.003934221342206001, 0.000970956461969763, 0.0002534482046030462, 0.009057780727744102, 0.020695818588137627, 0.00209142011590302, 0.0007412362028844655, 0.02349109947681427, 0.013371649198234081, -0.02870536968111992, -0.0020040676463395357, 0.0016319795977324247, 0.008318644016981125, 0.017362985759973526, -0.003796473378315568, -0.027818406000733376, 0.03072119690477848, -0.007015076465904713, 0.005597278475761414, 0.021905316039919853, 0.006669026333838701, -0.0099783418700099, 0.006050839554518461, 0.018518727272748947, -0.003883825847879052, -0.023907702416181564, 0.02414960227906704, 0.00717634242027998, -0.019432567059993744, -0.004545689094811678, 0.03469909355044365, 0.013801692053675652, -0.0036284876987338066, -0.02908165752887726, -0.01929817907512188, 0.00554016325622797, 0.06262501329183578, 0.02128712832927704, -0.004663278814405203, -0.004058530554175377, 0.0072166589088737965, 0.005315062589943409, -0.010717477649450302, -0.033328332006931305, 0.008903234265744686, -0.021609660238027573, -0.0017756072338670492, 0.0043945019133389, 0.015306842513382435, 0.006880688015371561, 0.01587127521634102, -0.003388268407434225, 0.0106905996799469, -0.006813493557274342, -0.0012649311684072018, -0.02339702658355236, -0.009702845476567745, 0.02746899612247944, 0.012813937850296497, 0.004579286091029644, 0.017658639699220657, 0.00025785781326703727, 0.004656559322029352, 0.01064356416463852, 0.012222628109157085, -0.05147077143192291, -0.020185142755508423, 0.031420014798641205, 0.008043147623538971, 0.009870830923318863, -0.005073163658380508, 0.02918916754424572, -0.005409134551882744, -0.015051504597067833, 0.01874718628823757, -0.0018915171967819333, 0.02156934328377247, 0.01939225196838379, 0.017080770805478096, -0.015710007399320602, 0.00946766510605812, -0.003310995176434517, 0.0021014991216361523, -0.0006963000632822514, -0.013909203000366688, -0.003715840168297291, 0.0020040676463395357, -0.008070025593042374, -0.007471997290849686, -0.023343270644545555, 0.008238011039793491, 0.009823794476687908, -0.009770039469003677, 0.006302817724645138, -0.018868137151002884, -0.026514839380979538, 0.007713896222412586, 0.008291766978800297, -0.006591752637177706, -0.0038099121302366257, -0.018290266394615173, -0.013136469759047031, -0.00042017383384518325, 0.003692322177812457, -0.020964596420526505, -0.00606091832742095, 0.002501304727047682, 0.008150658570230007, 0.0013002081541344523, 0.013606829568743706, 0.013526196591556072, 0.003998056054115295, 0.005143717397004366, -0.015374037437140942, -0.0233163945376873, -0.010724197141826153, -0.0012649311684072018, -0.035989224910736084, 0.007041953969746828, -0.010193362832069397, -0.023544853553175926, 0.016664166003465652, 0.005486407782882452, 0.011429736390709877, 0.005200832616537809, 0.012021045200526714, 0.024189919233322144, 0.0031816463451832533, 0.006269220728427172, -0.01691950485110283, 0.0030808548908680677, -0.026756737381219864, 0.0018881575670093298, -0.03453782945871353, -0.010536053217947483, -0.01921754702925682, -0.007384644355624914, -0.0034353043884038925, 0.00594668835401535, -0.0064909616485238075, 0.012417491525411606, 0.0025517004542052746, 0.008486629463732243, 0.031070606783032417, -0.014527389779686928, 0.019419129937887192, -0.0002673070121090859, 0.0004825384821742773, -0.010361348278820515, 0.0004439018084667623, -0.008258169516921043, 0.011853059753775597, 0.008748686872422695, -9.664418757893145e-05, 0.008701651357114315, -0.02281915582716465, 0.025506924837827682, -0.05923842266201973, 0.012242786586284637, 0.029511701315641403, 0.0008886435534805059, 0.014446756802499294, -0.011006413027644157, -0.012840814888477325, 0.003134610364213586, -0.006238983012735844, -0.009575176052749157, 0.0057249474339187145, -0.01834402233362198, -0.014406440779566765, -0.02967296727001667, -0.00779452919960022, -0.016220685094594955, 0.0038166316226124763, -0.018948769196867943, -0.007720615714788437, -0.02397489733994007, 0.0023366790264844894, 0.008775564841926098, -0.0001118153813877143, -0.022268163040280342, -0.02472747303545475, 0.0036822431720793247, 0.018142439424991608, -0.006863889284431934, 0.03434968367218971, 0.0008945230511017144, 0.01126847043633461, -0.013949519954621792, -0.018317144364118576, 0.0021367762237787247, -0.02718678116798401, -0.013989835977554321, -0.019701344892382622, 0.00979019794613123, 0.024270551279187202, 0.028597859665751457, -0.004421379417181015, 0.012726585380733013, 0.004226516466587782, -0.015938468277454376, 0.002533222083002329, 0.00260377605445683, -0.011685074307024479, -0.01826338842511177, 0.011167678982019424, 0.005378897301852703, 0.023612048476934433, 0.015468109399080276, -0.009588615037500858, 0.004149242769926786, -0.01493055559694767, 0.012820656411349773, -0.01665072701871395, -0.013922641985118389, -0.024794666096568108, 0.002948146313428879, 0.008285047486424446, -0.009299679659307003, 0.01230998057872057, -0.016664166003465652, 0.006813493557274342, 0.04609523341059685, 0.010576370172202587, 0.00865461491048336, 0.026944881305098534, 0.0003294616471976042, -0.018034927546977997, 0.012565318495035172, -0.000349619920598343, 0.015468109399080276, -0.01843809336423874, -0.015078382566571236, -0.012296541593968868, 0.0017974453512579203, 0.030855584889650345, 0.016207246109843254, -0.004481854382902384, -0.013102872297167778, 0.007263694889843464, 0.0011842980748042464, -0.017537690699100494, 0.006003803573548794, -0.002941426821053028, 0.01350603811442852, -0.004982451442629099, -0.032011326402425766, 0.0020847006235271692, -0.008352241478860378, -0.02472747303545475, -0.008379119448363781, 0.016005663201212883, -0.013600110076367855, 0.010905621573328972, -0.02404209040105343, -0.006830292288213968, -0.002209009835496545, 0.0004825384821742773, 0.029780477285385132, 0.0106905996799469, 0.001031431253068149, 0.008547104895114899, -0.0099783418700099, -0.005520005244761705, 0.007519032806158066, -0.009024183265864849, -0.011994168162345886, 0.035129137337207794, 0.016986697912216187, 0.0029716643039137125, -0.001743689994327724, 0.015535303391516209, 0.02236223593354225, -0.01616692915558815, -0.019795415922999382, 0.015710007399320602, 0.013660584576427937, 0.004723753314465284, -0.03934893384575844, -0.016301317140460014, -0.0503956638276577, 0.02339702658355236, 0.01646258309483528, -0.02025233767926693, -0.027818406000733376, 0.0006379251135513186]
#     data.append({"text": str(chunk), "vector": embedding})

# with open("my_dict1.json", "w") as f:
#     json.dump(data, f, indent=4)

with open('my_dict1.json', 'r') as f:
    data = json.load(f)
    print(data)

# Initialize a MilvusClient instance
# Replace uri and token with your own
client = MilvusClient(
    # Cluster endpoint obtained from the console
    uri="https://in03-575b131d648efbe.api.gcp-us-west1.zillizcloud.com",
    # - For a serverless cluster, use an API key as the token.
    # - For a dedicated cluster, use the cluster credentials as the token
    # in the format of 'user:password'.
        token="ade46ba572172c1a5655d38a460e85df620e2367068dbec49cb913ff491249881e5182d8f07dbacd0af53751289a389eef8715b8"
)

# res = client.describe_collection(
#     collection_name='operator_training'
# )


# res = client.delete(
#     collection_name="operator_training",  # Collection name
#     pks=444685500732500361  # Entity ID
# )

fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True),
    FieldSchema(name="text", dtype=DataType.VARCHAR, max_length=1024),
    FieldSchema(name="vector", dtype=DataType.FLOAT_VECTOR, dim=1536),
]

schema = CollectionSchema(
    fields,
    description="Schema",
    enable_dynamic_field=False
)

client.create_collection(
    collection_name="operator_training",
    dimension=1536,
    schema=schema
)


data = [{
    "id": random.randint(0, 1000000000),
    "text": "hello world",
    "vector": [0] * 1536
}, {
    "id": random.randint(0, 1000000000),
    "text": "hello world",
    "vector": [0] * 1536
}, {
    "id": random.randint(0, 1000000000),
    "text": "hello world",
    "vector": [0] * 1536
},]


res = client.insert(
    collection_name="operator_training",
    data=data
)
